name: Validate Registry PR

on:
  pull_request:
    paths:
      - 'registry.json'
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get base registry.json
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1
          git show origin/${{ github.base_ref }}:registry.json > /tmp/registry-base.json 2>/dev/null || echo '{"styles":[]}' > /tmp/registry-base.json

      - name: Run validation
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          chmod +x .github/scripts/validate-registry.sh
          .github/scripts/validate-registry.sh registry.json /tmp/registry-base.json

      - name: Post PR comment
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RESULT_FILE="/tmp/validation-result.md"
          if [ ! -f "$RESULT_FILE" ]; then
            echo "## Registry Validation" > "$RESULT_FILE"
            echo "" >> "$RESULT_FILE"
            echo ":x: Validation script failed to produce results." >> "$RESULT_FILE"
          fi

          gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            --jq '.[] | select(.user.login == "github-actions[bot]") | select(.body | startswith("## Registry Validation")) | .id' \
            | while read -r comment_id; do
                gh api -X DELETE repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments/"$comment_id"
              done

          gh pr comment ${{ github.event.pull_request.number }} --body-file "$RESULT_FILE"
